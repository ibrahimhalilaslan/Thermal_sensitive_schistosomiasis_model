dev.off()
############# Nguyen's result plot ######################
temp <- c(15.127, 15.763, 16.525, 16.949, 17.458, 17.881, 18.305, 18.814, 19.322, 19.831, 20.508, 21.186, 21.949, 22.797, 23.644, 24.153, 24.746,  25.085, 25.593,  26.102,  26.61,  27.119,  27.542,  28.136,  28.898, 29.576, 30.339,  31.441, 32.458, 33.814, 34.619)
rate <- c(0.11, 0.172, 0.282, 0.373, 0.467, 0.533, 0.621,  0.712, 0.806, 0.884, 0.953, 0.984, 0.994,  0.95, 0.84, 0.765, 0.665, 0.586,  0.502, 0.439, 0.376, 0.301, 0.254, 0.197, 0.144, 0.11, 0.072, 0.038, 0.025, 0.009, 0.009)
# keep just a single curve
.x <- data.frame(temp, rate)
nguyen <- nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
data = .x,
iter = c(4,4,4),
start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
supp_errors = 'Y')
fn_nguyen <- function(x) augment(nguyen, newdata = x)
df <- data.frame(x = r_not_data$temp, y2 = r_not_data$r_not_best, y1 = fn_nguyen(temperature)$.fitted)
# plot bootstrapped CIs
pdf(file = "mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
##################
pdf(file = "normalize_mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds_normalize, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
###############
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
##############################################################
setwd("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare")
setwd("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare")
source("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare/haematobium_boot_r_not.R")
########################## CALCULATE R_NOT ##################
# This is analytic representation of R not value without control.
r_not_boot <- (lambda * (boot3_preds_beta_s$pred * contact_reduction_s) * h * boot1_preds_delta_e$pred * nu_e * (boot1_preds_beta_h$pred * contact_reduction_h)
* boot1_preds_nu_c$pred * boot1_preds_sigma_s$pred/
(boot3_preds_mu_m$pred * (mu_h + mu_p) * boot3_preds_mu_c$pred * boot_preds_mu_i$pred
* (boot1_preds_sigma_s$pred + boot_preds_mu_i$pred)))^(1/2)
temp <- boot1_preds_beta_h$temp
boot_out_puts <- data.frame(temp, r_not_boot)
# calculate bootstrapped confidence intervals
boot_conf_preds <- boot_out_puts %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot, 0.975, na.rm = TRUE)) %>%
ungroup()
optim_temps <- c()
temp_row_length <- length(seq(min_temp, max_temp, by = 0.1))
for (i in 1:(length(boot1_preds_beta_h$temp)/temp_row_length)){
index <-  which.max(r_not_boot[(1+(i-1)*temp_row_length):(temp_row_length*i)])
optim_temps[i] <- boot_out_puts$temp[index+(i-1)*temp_row_length]
}
lower_bound <- quantile(optim_temps, 0.025, na.rm = TRUE)
upper_bound <- quantile(optim_temps, 0.975, na.rm = TRUE)
lower_bound
# 23.6
upper_bound
# 27.9
min_temp <- 12
max_temp <- 37
# Generate a sequence of temperature
temperature <- data.frame(temp = seq(min_temp, max_temp, by = 0.1))
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(temperature)$.fitted[which(temperature$temp <= 37)]
preds_2 <- fn_mu_i_2(temperature)$.fitted[which(temperature$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
# This is analytic representation of R not value without control.
r_not_best <- (abs(lambda * fn_beta_s(temperature)$.fitted * h * fn_delta_e(temperature)$.fitted * nu_e
* fn_beta_h(temperature)$.fitted * fn_nu_c(temperature)$.fitted * fn_sigma_s(temperature)$.fitted/
(fn_mu_m(temperature)$.fitted * (mu_h + mu_p) * fn_mu_c(temperature)$.fitted * preds_mu_i *
(fn_sigma_s(temperature)$.fitted + preds_mu_i))))^(1/2)
r_not_data <- data.frame(temp, r_not_best)
# We actually do this to test Nguyen results with our model, we do simulation with increasing some of
# our parameter values as disease control strategies.
prev_percent <- read.csv(file = 'gntd_vars_all.csv')
head(prev_percent)
sch_heamatobium_ind <- which(prev_percent$parasite_s == "S. haematobium")
sch_heamatobium <- prev_percent[sch_heamatobium_ind, ]
sch_heamatobium <- sch_heamatobium[-which(sch_heamatobium$percent_pos == 0),]
sch_heamatobium <- sch_heamatobium[-c(which(is.na(sch_heamatobium$bio01))),]
sch_heamatobium_sort <- sch_heamatobium[order(sch_heamatobium$bio01), ]
sum(is.na(sch_heamatobium_sort$bio01))
length(sch_heamatobium_sort$bio01)
sch_heamatobium_temp_unq <- sch_heamatobium %>% group_by(bio01) %>%
summarize(med = median(percent_pos), na.rm = TRUE)
# plot bootstrapped CIs
pdf(file = "heamatobium_data_median.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(bio01, med), sch_heamatobium_temp_unq, col = 'blue') +
labs(title = "S.heamatobium",
x = 'Temperature (ºC)',
y = expression("R"[0]))+
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
bins_maker <- function(percentile, lenth_of_bin){
out_put <- matrix(0, nrow = 2, ncol = round(length(sch_heamatobium_sort$bio01)/lenth_of_bin))
for (i in 1:round(length(sch_heamatobium_sort$bio01)/lenth_of_bin)){
index_of_bin <- (1+(i-1)*lenth_of_bin):(i*lenth_of_bin)
out_put[1, i] <- sch_heamatobium_sort$bio01[index_of_bin[lenth_of_bin/2]]
out_put[2, i] <- quantile(sch_heamatobium_sort$percent_pos[index_of_bin], na.rm = TRUE, probs = percentile)
}
return(out_put)
}
bins_data <-bins_maker(percentile = .95, lenth_of_bin = 400)
d <- data.frame(bins_data[1,], bins_data[2,])
colnames(d) <- c("temp", "prev")
# plot bootstrapped CIs
pdf(file = "haematobium_boost_r_not.pdf", width = 5, height = 5)
ggplot() +
geom_line(aes(temp, r_not_best), r_not_data, col = 'blue', size = 1) +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds, fill = 'blue', alpha = 0.1) +
geom_point(aes(temp, prev*max(r_not_best)/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = expression("R"[0]))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
############# Nguyen's result plot ######################
temp <- c(15.127, 15.763, 16.525, 16.949, 17.458, 17.881, 18.305, 18.814, 19.322, 19.831, 20.508, 21.186, 21.949, 22.797, 23.644, 24.153, 24.746,  25.085, 25.593,  26.102,  26.61,  27.119,  27.542,  28.136,  28.898, 29.576, 30.339,  31.441, 32.458, 33.814, 34.619)
rate <- c(0.11, 0.172, 0.282, 0.373, 0.467, 0.533, 0.621,  0.712, 0.806, 0.884, 0.953, 0.984, 0.994,  0.95, 0.84, 0.765, 0.665, 0.586,  0.502, 0.439, 0.376, 0.301, 0.254, 0.197, 0.144, 0.11, 0.072, 0.038, 0.025, 0.009, 0.009)
# keep just a single curve
.x <- data.frame(temp, rate)
nguyen <- nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
data = .x,
iter = c(4,4,4),
start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
supp_errors = 'Y')
fn_nguyen <- function(x) augment(nguyen, newdata = x)
df <- data.frame(x = r_not_data$temp, y2 = r_not_data$r_not_best, y1 = fn_nguyen(temperature)$.fitted)
#expression("R"[0]/max(("R"[0])))
# plot bootstrapped CIs
pdf(file = "haematobium_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(r_not_best), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "blue")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'blue', alpha = 0.1) +
labs(title = "S.haematobium", x = '',y = "")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
#Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "blue", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "blue", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "blue", size = 1)
dev.off()
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
source("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare/haematobium_boot_r_not.R")
########################## CALCULATE R_NOT ##################
# This is analytic representation of R not value without control.
r_not_boot <- (lambda * (boot3_preds_beta_s$pred * contact_reduction_s) * h * boot1_preds_delta_e$pred * nu_e * (boot1_preds_beta_h$pred * contact_reduction_h)
* boot1_preds_nu_c$pred * boot1_preds_sigma_s$pred/
(boot3_preds_mu_m$pred * (mu_h + mu_p) * boot3_preds_mu_c$pred * boot_preds_mu_i$pred
* (boot1_preds_sigma_s$pred + boot_preds_mu_i$pred)))^(1/2)
temp <- boot1_preds_beta_h$temp
boot_out_puts <- data.frame(temp, r_not_boot)
# calculate bootstrapped confidence intervals
boot_conf_preds <- boot_out_puts %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot, 0.975, na.rm = TRUE)) %>%
ungroup()
optim_temps <- c()
temp_row_length <- length(seq(min_temp, max_temp, by = 0.1))
for (i in 1:(length(boot1_preds_beta_h$temp)/temp_row_length)){
index <-  which.max(r_not_boot[(1+(i-1)*temp_row_length):(temp_row_length*i)])
optim_temps[i] <- boot_out_puts$temp[index+(i-1)*temp_row_length]
}
lower_bound <- quantile(optim_temps, 0.025, na.rm = TRUE)
upper_bound <- quantile(optim_temps, 0.975, na.rm = TRUE)
lower_bound
# 23.6
upper_bound
# 27.9
min_temp <- 12
max_temp <- 37
# Generate a sequence of temperature
temperature <- data.frame(temp = seq(min_temp, max_temp, by = 0.1))
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(temperature)$.fitted[which(temperature$temp <= 37)]
preds_2 <- fn_mu_i_2(temperature)$.fitted[which(temperature$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
# This is analytic representation of R not value without control.
r_not_best <- (abs(lambda * fn_beta_s(temperature)$.fitted * h * fn_delta_e(temperature)$.fitted * nu_e
* fn_beta_h(temperature)$.fitted * fn_nu_c(temperature)$.fitted * fn_sigma_s(temperature)$.fitted/
(fn_mu_m(temperature)$.fitted * (mu_h + mu_p) * fn_mu_c(temperature)$.fitted * preds_mu_i *
(fn_sigma_s(temperature)$.fitted + preds_mu_i))))^(1/2)
r_not_data <- data.frame(temp, r_not_best)
# We actually do this to test Nguyen results with our model, we do simulation with increasing some of
# our parameter values as disease control strategies.
prev_percent <- read.csv(file = 'gntd_vars_all.csv')
head(prev_percent)
sch_heamatobium_ind <- which(prev_percent$parasite_s == "S. haematobium")
sch_heamatobium <- prev_percent[sch_heamatobium_ind, ]
sch_heamatobium <- sch_heamatobium[-which(sch_heamatobium$percent_pos == 0),]
sch_heamatobium <- sch_heamatobium[-c(which(is.na(sch_heamatobium$bio01))),]
sch_heamatobium_sort <- sch_heamatobium[order(sch_heamatobium$bio01), ]
sum(is.na(sch_heamatobium_sort$bio01))
length(sch_heamatobium_sort$bio01)
sch_heamatobium_temp_unq <- sch_heamatobium %>% group_by(bio01) %>%
summarize(med = median(percent_pos), na.rm = TRUE)
# plot bootstrapped CIs
pdf(file = "heamatobium_data_median.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(bio01, med), sch_heamatobium_temp_unq, col = 'blue') +
labs(title = "S.heamatobium",
x = 'Temperature (ºC)',
y = expression("R"[0]))+
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
bins_maker <- function(percentile, lenth_of_bin){
out_put <- matrix(0, nrow = 2, ncol = round(length(sch_heamatobium_sort$bio01)/lenth_of_bin))
for (i in 1:round(length(sch_heamatobium_sort$bio01)/lenth_of_bin)){
index_of_bin <- (1+(i-1)*lenth_of_bin):(i*lenth_of_bin)
out_put[1, i] <- sch_heamatobium_sort$bio01[index_of_bin[lenth_of_bin/2]]
out_put[2, i] <- quantile(sch_heamatobium_sort$percent_pos[index_of_bin], na.rm = TRUE, probs = percentile)
}
return(out_put)
}
bins_data <-bins_maker(percentile = .95, lenth_of_bin = 400)
d <- data.frame(bins_data[1,], bins_data[2,])
colnames(d) <- c("temp", "prev")
# plot bootstrapped CIs
pdf(file = "haematobium_boost_r_not.pdf", width = 5, height = 5)
ggplot() +
geom_line(aes(temp, r_not_best), r_not_data, col = 'blue', size = 1) +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds, fill = 'blue', alpha = 0.1) +
geom_point(aes(temp, prev*max(r_not_best)/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = expression("R"[0]))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
############# Nguyen's result plot ######################
temp <- c(15.127, 15.763, 16.525, 16.949, 17.458, 17.881, 18.305, 18.814, 19.322, 19.831, 20.508, 21.186, 21.949, 22.797, 23.644, 24.153, 24.746,  25.085, 25.593,  26.102,  26.61,  27.119,  27.542,  28.136,  28.898, 29.576, 30.339,  31.441, 32.458, 33.814, 34.619)
rate <- c(0.11, 0.172, 0.282, 0.373, 0.467, 0.533, 0.621,  0.712, 0.806, 0.884, 0.953, 0.984, 0.994,  0.95, 0.84, 0.765, 0.665, 0.586,  0.502, 0.439, 0.376, 0.301, 0.254, 0.197, 0.144, 0.11, 0.072, 0.038, 0.025, 0.009, 0.009)
# keep just a single curve
.x <- data.frame(temp, rate)
nguyen <- nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
data = .x,
iter = c(4,4,4),
start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
supp_errors = 'Y')
fn_nguyen <- function(x) augment(nguyen, newdata = x)
df <- data.frame(x = r_not_data$temp, y2 = r_not_data$r_not_best, y1 = fn_nguyen(temperature)$.fitted)
#expression("R"[0]/max(("R"[0])))
# plot bootstrapped CIs
pdf(file = "haematobium_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(r_not_best), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "blue")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'blue', alpha = 0.1) +
labs(title = "S.haematobium", x = '',y = "")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
#Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "blue", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "blue", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "blue", size = 1)
dev.off()
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
setwd("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare")
source("G:/.shortcut-targets-by-id/1e2xUwinp8NuntTAkfNCUIW_48Onf6MCd/Belmont Project/Thermal_sensitive_models/r_ibrahim_scripts/the_first_paper_code/submitted_first_paper_code/s.haematobium/2_r_not_mod_val_compare/haematobium_boot_r_not.R")
########################## CALCULATE R_NOT ##################
# This is analytic representation of R not value without control.
r_not_boot <- (lambda * (boot3_preds_beta_s$pred * contact_reduction_s) * h * boot1_preds_delta_e$pred * nu_e * (boot1_preds_beta_h$pred * contact_reduction_h)
* boot1_preds_nu_c$pred * boot1_preds_sigma_s$pred/
(boot3_preds_mu_m$pred * (mu_h + mu_p) * boot3_preds_mu_c$pred * boot_preds_mu_i$pred
* (boot1_preds_sigma_s$pred + boot_preds_mu_i$pred)))^(1/2)
temp <- boot1_preds_beta_h$temp
boot_out_puts <- data.frame(temp, r_not_boot)
# calculate bootstrapped confidence intervals
boot_conf_preds <- boot_out_puts %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot, 0.975, na.rm = TRUE)) %>%
ungroup()
optim_temps <- c()
temp_row_length <- length(seq(min_temp, max_temp, by = 0.1))
for (i in 1:(length(boot1_preds_beta_h$temp)/temp_row_length)){
index <-  which.max(r_not_boot[(1+(i-1)*temp_row_length):(temp_row_length*i)])
optim_temps[i] <- boot_out_puts$temp[index+(i-1)*temp_row_length]
}
lower_bound <- quantile(optim_temps, 0.025, na.rm = TRUE)
upper_bound <- quantile(optim_temps, 0.975, na.rm = TRUE)
lower_bound
# 23.6
upper_bound
# 27.9
min_temp <- 12
max_temp <- 37
# Generate a sequence of temperature
temperature <- data.frame(temp = seq(min_temp, max_temp, by = 0.1))
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(temperature)$.fitted[which(temperature$temp <= 37)]
preds_2 <- fn_mu_i_2(temperature)$.fitted[which(temperature$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
# This is analytic representation of R not value without control.
r_not_best <- (abs(lambda * fn_beta_s(temperature)$.fitted * h * fn_delta_e(temperature)$.fitted * nu_e
* fn_beta_h(temperature)$.fitted * fn_nu_c(temperature)$.fitted * fn_sigma_s(temperature)$.fitted/
(fn_mu_m(temperature)$.fitted * (mu_h + mu_p) * fn_mu_c(temperature)$.fitted * preds_mu_i *
(fn_sigma_s(temperature)$.fitted + preds_mu_i))))^(1/2)
r_not_data <- data.frame(temp, r_not_best)
# We actually do this to test Nguyen results with our model, we do simulation with increasing some of
# our parameter values as disease control strategies.
prev_percent <- read.csv(file = 'gntd_vars_all.csv')
head(prev_percent)
sch_heamatobium_ind <- which(prev_percent$parasite_s == "S. haematobium")
sch_heamatobium <- prev_percent[sch_heamatobium_ind, ]
sch_heamatobium <- sch_heamatobium[-which(sch_heamatobium$percent_pos == 0),]
sch_heamatobium <- sch_heamatobium[-c(which(is.na(sch_heamatobium$bio01))),]
sch_heamatobium_sort <- sch_heamatobium[order(sch_heamatobium$bio01), ]
sum(is.na(sch_heamatobium_sort$bio01))
length(sch_heamatobium_sort$bio01)
sch_heamatobium_temp_unq <- sch_heamatobium %>% group_by(bio01) %>%
summarize(med = median(percent_pos), na.rm = TRUE)
# plot bootstrapped CIs
pdf(file = "heamatobium_data_median.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(bio01, med), sch_heamatobium_temp_unq, col = 'blue') +
labs(title = "S.heamatobium",
x = 'Temperature (ºC)',
y = expression("R"[0]))+
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
bins_maker <- function(percentile, lenth_of_bin){
out_put <- matrix(0, nrow = 2, ncol = round(length(sch_heamatobium_sort$bio01)/lenth_of_bin))
for (i in 1:round(length(sch_heamatobium_sort$bio01)/lenth_of_bin)){
index_of_bin <- (1+(i-1)*lenth_of_bin):(i*lenth_of_bin)
out_put[1, i] <- sch_heamatobium_sort$bio01[index_of_bin[lenth_of_bin/2]]
out_put[2, i] <- quantile(sch_heamatobium_sort$percent_pos[index_of_bin], na.rm = TRUE, probs = percentile)
}
return(out_put)
}
bins_data <-bins_maker(percentile = .95, lenth_of_bin = 400)
d <- data.frame(bins_data[1,], bins_data[2,])
colnames(d) <- c("temp", "prev")
# plot bootstrapped CIs
pdf(file = "haematobium_boost_r_not.pdf", width = 5, height = 5)
ggplot() +
geom_line(aes(temp, r_not_best), r_not_data, col = 'blue', size = 1) +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds, fill = 'blue', alpha = 0.1) +
geom_point(aes(temp, prev*max(r_not_best)/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
labs(title = "S.haematobium", x = 'Temperature (ºC)',y = expression("R"[0]))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
############# Nguyen's result plot ######################
temp <- c(15.127, 15.763, 16.525, 16.949, 17.458, 17.881, 18.305, 18.814, 19.322, 19.831, 20.508, 21.186, 21.949, 22.797, 23.644, 24.153, 24.746,  25.085, 25.593,  26.102,  26.61,  27.119,  27.542,  28.136,  28.898, 29.576, 30.339,  31.441, 32.458, 33.814, 34.619)
rate <- c(0.11, 0.172, 0.282, 0.373, 0.467, 0.533, 0.621,  0.712, 0.806, 0.884, 0.953, 0.984, 0.994,  0.95, 0.84, 0.765, 0.665, 0.586,  0.502, 0.439, 0.376, 0.301, 0.254, 0.197, 0.144, 0.11, 0.072, 0.038, 0.025, 0.009, 0.009)
# keep just a single curve
.x <- data.frame(temp, rate)
nguyen <- nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
data = .x,
iter = c(4,4,4),
start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
supp_errors = 'Y')
fn_nguyen <- function(x) augment(nguyen, newdata = x)
df <- data.frame(x = r_not_data$temp, y2 = r_not_data$r_not_best, y1 = fn_nguyen(temperature)$.fitted)
#expression("R"[0]/max(("R"[0])))
# plot bootstrapped CIs
pdf(file = "haematobium_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(r_not_best), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "blue")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "blue") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'blue', alpha = 0.1) +
labs(title = "S.haematobium", x = '',y = "")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
#Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "blue", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "blue", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "blue", size = 1)
dev.off()
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
boot1_preds_sigma_s$pred
