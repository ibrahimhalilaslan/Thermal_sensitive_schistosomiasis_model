year <- 1
# set time span
run_time <- seq(from = 0, to = 366*year-1, by = 1)
#we run the model with constant temperature first. 25 degree, this is approximately annual water temperature
# Set constant temperature
temperature_span <- seq(15, 37, by = 0.5)
equilibrium <- matrix(NA, ncol = length(temperature_span), nrow = 6)
for (j in 1:length(temperature_span)){
sample_parameters <- seq(from = 0, to = 366*year, by = 1)
seasonal_temperature <- data.frame(temp = rep(temperature_span[j], length(sample_parameters)))
# Generate linearly interpolate point with temperature dependent parameter function to use them in the solution of diff equations.
nu_s_afun <- approxfun(x = sample_parameters, y = ifelse(fn_nu_s(seasonal_temperature)$.fitted >= 0,
fn_nu_s(seasonal_temperature)$.fitted,0))
mu_m_afun <- approxfun(x = sample_parameters, y = ifelse(fn_mu_m(seasonal_temperature)$.fitted >= 0,
fn_mu_m(seasonal_temperature)$.fitted,0))
mu_afun <- approxfun(x = sample_parameters, y = ifelse(seasonal_temperature$temp <= 35.5,
ifelse(fn_mu_1(seasonal_temperature)$.fitted >= 0,fn_mu_1(seasonal_temperature)$.fitted, 0),
ifelse(fn_mu_2(seasonal_temperature)$.fitted >= 0,fn_mu_2(seasonal_temperature)$.fitted, 0)))
sigma_s_afun <- approxfun(x = sample_parameters, y = ifelse(fn_sigma_s(seasonal_temperature)$.fitted >= 0,
fn_sigma_s(seasonal_temperature)$.fitted,0))
mu_i_afun <- approxfun(x = sample_parameters, y = ifelse(seasonal_temperature$temp <= 34,
ifelse(fn_mu_i_1(seasonal_temperature)$.fitted >= 0,fn_mu_i_1(seasonal_temperature)$.fitted, 0),
ifelse(fn_mu_i_2(seasonal_temperature)$.fitted >= 0,fn_mu_i_2(seasonal_temperature)$.fitted, 0)))
nu_c_afun <- approxfun(x = sample_parameters, y = ifelse(fn_nu_c(seasonal_temperature)$.fitted >= 0,
fn_nu_c(seasonal_temperature)$.fitted,0))
mu_c_afun <- approxfun(x = sample_parameters, y = ifelse(fn_mu_c(seasonal_temperature)$.fitted >= 0,
fn_mu_c(seasonal_temperature)$.fitted,0))
delta_e_afun <- approxfun(x = sample_parameters, y = ifelse(fn_delta_e(seasonal_temperature)$.fitted >= 0,
fn_delta_e(seasonal_temperature)$.fitted,0))
beta_s_afun <- approxfun(x = sample_parameters, y = ifelse(fn_beta_s(seasonal_temperature)$.fitted >= 0,
fn_beta_s(seasonal_temperature)$.fitted, 0))
beta_h_afun <- approxfun(x = sample_parameters, y = ifelse(fn_beta_h(seasonal_temperature)$.fitted >= 0,
fn_beta_h(seasonal_temperature)$.fitted, 0))
#Call the library
library(deSolve)
#the diff equation solver
thermal_sensitive_model <- function(t, y, parms){
with(as.list(c(y, parms)),
{
nu_s <- nu_s_afun(t)
mu_m <- mu_m_afun(t)
mu <- mu_afun(t)
sigma_s <- sigma_s_afun(t)
mu_i <- mu_i_afun(t)
nu_c <- nu_c_afun(t)
mu_c <- mu_c_afun(t)
delta_e <- delta_e_afun(t)
beta_s <- beta_s_afun(t)
beta_h <- beta_h_afun(t)
dS <- (nu_s - (S + E + I) * nu) * (S + r * E) -  lambda * (1-exp(-(beta_s * delta_e * nu_e * h * P_m)/(mu_m * (S + E + I)))) * S - mu * S
dE <- lambda * (1-exp(-(beta_s * delta_e * nu_e *h * P_m)/(mu_m * (S + E + I)))) * S - (sigma_s + mu_i) * E
dI <- sigma_s * E - mu_i * I
dP <- beta_h * (nu_c/mu_c) * I - sigma_p * P
dP_m <- sigma_p * P - (mu_h + mu_p) * P_m
dC <- nu_c * I - mu_c*C
return(list(c(S = dS, E = dE, I = dI, P = dP, P_m = dP_m, C = dC)))
})
}
# Specified the parameter value. These might be changed later because they are prevalence dependent.
parms0 <- c(nu, lambda)
# Set the initial conditions
y0 <- c(S = (60434 + 33232)/2,  E = 1285, I = 2340, P = 2, P_m = 105, C = 2340*1200)
## solve the system
model_outputs <- ode(y = y0, times = run_time, func = thermal_sensitive_model, parms = parms0)
# print the equilibrium point and prevalence
equilibrium[,j] <- model_outputs[length(model_outputs[, 1]), 2:7]
}
simulation_data_frame <- data.frame(temperature_span, equilibrium[1, ], equilibrium[3, ], equilibrium[6, ])
colnames(simulation_data_frame) <- c("Temperature", "Snails", "Infected", "Cercarial")
#############  Snails' abundance ###############
experiment_data_frame <- data.frame(snail_abundance = c(snails_aboundance[, 1], snails_aboundance[, 2], snails_aboundance[, 3],
snails_aboundance[, 4], snails_aboundance[, 5], snails_aboundance[, 6]),
Temp = c(rep(18, length(snails_aboundance[, 1])), rep(21, length(snails_aboundance[, 1])),
rep(25, length(snails_aboundance[, 1])), rep(29, length(snails_aboundance[, 1])),
rep(33, length(snails_aboundance[, 1])), rep(37, length(snails_aboundance[, 1]))))
# Normalize the simulation values to match the scale of snails abundance scale
max_snails <- max(experiment_data_frame$snail_abundance, na.rm = TRUE)
max_simulation_value <- max(simulation_data_frame$Snails, na.rm = TRUE)
simulation_data_frame$Normalized_snail <- simulation_data_frame$Snails/max_simulation_value
experiment_data_frame$Normalized_snail <- experiment_data_frame$snail_abundance/max_snails
ggplot() +
geom_line(data = simulation_data_frame, aes(x = Temperature, y = Normalized_snail),
color = "red", size = 1) +  # Adding simulation line
geom_point(data = experiment_data_frame, aes(x = Temp, y = Normalized_snail),
color = "blue", size = 3, shape = 16) +  # Adding experimental points
theme_minimal() +
labs(
title = "Snails' abundance by Temperature",
x = "Temperature",
y = "Snails' abundance"
)
#############  Infected Intensity ###############
experiment_data_frame <- data.frame(infected_intensity = c(infected_density[, 1], infected_density[, 2], infected_density[, 3],
infected_density[, 4], infected_density[, 5], infected_density[, 6]),
Temp = c(rep(18, length(infected_density[, 1])), rep(21, length(infected_density[, 1])),
rep(25, length(infected_density[, 1])), rep(29, length(infected_density[, 1])),
rep(33, length(infected_density[, 1])), rep(37, length(infected_density[, 1]))))
# Normalize the simulation values to match the scale of infected
max_infected_density <- max(experiment_data_frame$infected_intensity, na.rm = TRUE)
max_simulation_value <- max(simulation_data_frame$Infected, na.rm = TRUE)
simulation_data_frame$Normalized_infected <- simulation_data_frame$Infected/max_simulation_value
experiment_data_frame$Normalized_infected <- experiment_data_frame$infected_intensity/max_infected_density
ggplot() +
geom_line(data = simulation_data_frame, aes(x = Temperature, y = Normalized_infected),
color = "red", size = 1) +  # Adding simulation line
geom_point(data = experiment_data_frame, aes(x = Temp, y = Normalized_infected),
color = "blue", size = 3, shape = 16) +  # Adding experimental points
theme_minimal() +
labs(
title = "Infected intensity by Temperature",
x = "Temperature",
y = "Infected intensity"
)
################ Cercarial abundance ################
experiment_data_frame <- data.frame(cer_density = c(cercarial_density[, 1], cercarial_density[, 2], cercarial_density[, 3],
cercarial_density[, 4], cercarial_density[, 5], cercarial_density[, 6]),
Temp = c(rep(18, length(cercarial_density[, 1])), rep(21, length(cercarial_density[, 1])),
rep(25, length(cercarial_density[, 1])), rep(29, length(cercarial_density[, 1])),
rep(33, length(cercarial_density[, 1])), rep(37, length(cercarial_density[, 1]))))
# Normalize the simulation values to match the scale of cercarial_density
max_cercarial_density <- max(experiment_data_frame$cer_density, na.rm = TRUE)
max_simulation_value <- max(simulation_data_frame$Cercarial, na.rm = TRUE)
simulation_data_frame$Normalized_Cercarial <- simulation_data_frame$Cercarial/max_simulation_value
experiment_data_frame$Normalized_Cercarial <- experiment_data_frame$cer_density/max_cercarial_density
ggplot() +
geom_line(data = simulation_data_frame, aes(x = Temperature, y = Normalized_Cercarial),
color = "red", size = 1) +  # Adding simulation line
geom_point(data = experiment_data_frame, aes(x = Temp, y = Normalized_Cercarial),
color = "blue", size = 3, shape = 16) +  # Adding experimental points
theme_minimal() +
labs(
title = "Cercarial Density by Temperature",
x = "Temperature",
y = "Cercarial Density"
)
################ simulation with prevalence ##############
experiment_data_frame <- data.frame(prevalence = c(infected_density[, 1]/snails_aboundance[,1], infected_density[, 2]/snails_aboundance[,2], infected_density[, 3]/snails_aboundance[,3],
infected_density[, 4]/snails_aboundance[,4], infected_density[, 5]/snails_aboundance[,5], infected_density[, 6]/snails_aboundance[,6]),
Temp = c(rep(18, length(infected_density[, 1])), rep(21, length(infected_density[, 1])),
rep(25, length(infected_density[, 1])), rep(29, length(infected_density[, 1])),
rep(33, length(infected_density[, 1])), rep(37, length(infected_density[, 1]))))
simulation_data_frame$Prevalence <- simulation_data_frame$Infected/simulation_data_frame$Snails
# Normalize the simulation values to match the scale of infected
max_prevalence <- max(experiment_data_frame$prevalence, na.rm = TRUE)
max_simulation_value <- max(simulation_data_frame$Prevalence, na.rm = TRUE)
simulation_data_frame$Normalized_prevalence <- simulation_data_frame$Prevalence/max_simulation_value
experiment_data_frame$Normalized_prevalence <- experiment_data_frame$prevalence/max_prevalence
ggplot() +
geom_line(data = simulation_data_frame, aes(x = Temperature, y = Normalized_prevalence),
color = "red", size = 1) +  # Adding simulation line
geom_point(data = experiment_data_frame, aes(x = Temp, y = Normalized_prevalence),
color = "blue", size = 3, shape = 16) +  # Adding experimental points
theme_minimal() +
labs(
title = "Infected intensity by Temperature",
x = "Temperature",
y = "Infected intensity"
)
setwd("C:/Users/iaslan/OneDrive - Stanford/Desktop/GitHub/Thermal_sensitive_schistosomiasis_model/s.mansoni/r_not_mod_compare")
source("C:/Users/iaslan/OneDrive - Stanford/Desktop/GitHub/Thermal_sensitive_schistosomiasis_model/s.mansoni/r_not_mod_compare/mansoni_boot_r_not.R")
bins_data <-bins_maker(percentile = .98, lenth_of_bin = 400)
# This is analytic representation of R not value without control.
r_not_boot <- (lambda * (boot1_preds_beta_s$pred * contact_reduction_s) * h * boot1_preds_delta_e$pred * nu_e * (boot1_preds_beta_h$pred * contact_reduction_h)
* boot1_preds_nu_c$pred * boot1_preds_sigma_s$pred/
(boot1_preds_mu_m$pred * (mu_h + mu_p) * boot3_preds_mu_c$pred * boot_preds_mu_i$pred
* (boot1_preds_sigma_s$pred + boot_preds_mu_i$pred)))^(1/2)
r_not_boot_normalize <- c()
#In case we want to process the reviewer suggestion
for (i in 1:999){
r_not_boot_normalize[(1+(i-1)*251):(i*251)] <- r_not_boot[(1+(i-1)*251):(i*251)]/max(r_not_boot[(1+(i-1)*251):(i*251)])
}
temp <- boot1_preds_beta_h$temp
boot_out_puts <- data.frame(temp, r_not_boot)
boot_out_puts_normalize <- data.frame(temp, r_not_boot_normalize)
# calculate bootstrapped confidence intervals
boot_conf_preds <- boot_out_puts %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot, 0.975, na.rm = TRUE)) %>%
ungroup()
# calculate bootstrapped confidence intervals
boot_conf_preds_normalize <- boot_out_puts_normalize %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot_normalize, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot_normalize, 0.975, na.rm = TRUE)) %>%
ungroup()
optim_temps <- c()
temp_row_length <- length(seq(min_temp, max_temp, by = 0.1))
for (i in 1:(length(boot1_preds_beta_h$temp)/temp_row_length)){
index <-  which.max(r_not_boot[(1+(i-1)*temp_row_length):(temp_row_length*i)])
optim_temps[i] <- boot_out_puts$temp[index+(i-1)*temp_row_length]
}
lower_bound <- quantile(optim_temps, 0.025, na.rm = TRUE)
upper_bound <- quantile(optim_temps, 0.975, na.rm = TRUE)
lower_bound
upper_bound
min_temp <- 12
max_temp <- 37
# Generate a sequence of temperature
temperature <- data.frame(temp = seq(min_temp, max_temp, by = 0.1))
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(temperature)$.fitted[which(temperature$temp <= 37)]
preds_2 <- fn_mu_i_2(temperature)$.fitted[which(temperature$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
# This is analytic representation of R not value without control.
r_not_best <- (abs(lambda * fn_beta_s(temperature)$.fitted * h * fn_delta_e(temperature)$.fitted * nu_e
* fn_beta_h(temperature)$.fitted * fn_nu_c(temperature)$.fitted * fn_sigma_s(temperature)$.fitted/
(fn_mu_m(temperature)$.fitted * (mu_h + mu_p) * fn_mu_c(temperature)$.fitted * preds_mu_i *
(fn_sigma_s(temperature)$.fitted + preds_mu_i))))^(1/2)
plot(temperature$temp, r_not_best)
r_not_data <- data.frame(temperature, r_not_best)
# We actually do this to test Nguyen results with our model, we do simulation with increasing some of
# our parameter values as disease control strategies.
prev_percent <- read.csv(file = 'gntd_vars_all.csv')
# This is analytic representation of R not value without control.
r_not_boot <- (lambda * (boot1_preds_beta_s$pred * contact_reduction_s) * h * boot1_preds_delta_e$pred * nu_e * (boot1_preds_beta_h$pred * contact_reduction_h)
* boot1_preds_nu_c$pred * boot1_preds_sigma_s$pred/
(boot1_preds_mu_m$pred * (mu_h + mu_p) * boot3_preds_mu_c$pred * boot_preds_mu_i$pred
* (boot1_preds_sigma_s$pred + boot_preds_mu_i$pred)))^(1/2)
r_not_boot_normalize <- c()
#In case we want to process the reviewer suggestion
for (i in 1:999){
r_not_boot_normalize[(1+(i-1)*251):(i*251)] <- r_not_boot[(1+(i-1)*251):(i*251)]/max(r_not_boot[(1+(i-1)*251):(i*251)])
}
temp <- boot1_preds_beta_h$temp
boot_out_puts <- data.frame(temp, r_not_boot)
boot_out_puts_normalize <- data.frame(temp, r_not_boot_normalize)
# calculate bootstrapped confidence intervals
boot_conf_preds <- boot_out_puts %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot, 0.975, na.rm = TRUE)) %>%
ungroup()
# calculate bootstrapped confidence intervals
boot_conf_preds_normalize <- boot_out_puts_normalize %>% group_by(temp) %>%
summarise(conf_lower = quantile(r_not_boot_normalize, 0.025, na.rm = TRUE),
conf_upper = quantile(r_not_boot_normalize, 0.975, na.rm = TRUE)) %>%
ungroup()
optim_temps <- c()
temp_row_length <- length(seq(min_temp, max_temp, by = 0.1))
for (i in 1:(length(boot1_preds_beta_h$temp)/temp_row_length)){
index <-  which.max(r_not_boot[(1+(i-1)*temp_row_length):(temp_row_length*i)])
optim_temps[i] <- boot_out_puts$temp[index+(i-1)*temp_row_length]
}
lower_bound <- quantile(optim_temps, 0.025, na.rm = TRUE)
upper_bound <- quantile(optim_temps, 0.975, na.rm = TRUE)
lower_bound
upper_bound
min_temp <- 12
max_temp <- 37
# Generate a sequence of temperature
temperature <- data.frame(temp = seq(min_temp, max_temp, by = 0.1))
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(temperature)$.fitted[which(temperature$temp <= 37)]
preds_2 <- fn_mu_i_2(temperature)$.fitted[which(temperature$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
# This is analytic representation of R not value without control.
r_not_best <- (abs(lambda * fn_beta_s(temperature)$.fitted * h * fn_delta_e(temperature)$.fitted * nu_e
* fn_beta_h(temperature)$.fitted * fn_nu_c(temperature)$.fitted * fn_sigma_s(temperature)$.fitted/
(fn_mu_m(temperature)$.fitted * (mu_h + mu_p) * fn_mu_c(temperature)$.fitted * preds_mu_i *
(fn_sigma_s(temperature)$.fitted + preds_mu_i))))^(1/2)
plot(temperature$temp, r_not_best)
r_not_data <- data.frame(temperature, r_not_best)
# We actually do this to test Nguyen results with our model, we do simulation with increasing some of
# our parameter values as disease control strategies.
prev_percent <- read.csv(file = 'gntd_vars_all.csv')
head(prev_percent)
sch_mansoni_ind <- which(prev_percent$parasite_s == "S. mansoni")
sch_mansoni <- prev_percent[sch_mansoni_ind, ]
sch_mansoni <- sch_mansoni[-which(sch_mansoni$percent_pos == 0),]
sch_mansoni <- sch_mansoni[-c(which(is.na(sch_mansoni$bio01))),]
sch_mansoni_sort <- sch_mansoni[order(sch_mansoni$bio01), ]
sum(is.na(sch_mansoni_sort$bio01))
length(sch_mansoni_sort$bio01)
sch_mansoni_temp_unq <- sch_mansoni %>% group_by(bio01) %>%
summarize(med = median(percent_pos), na.rm = TRUE)
sch_mansoni_temp_unq_mean <- sch_mansoni %>% group_by(bio01) %>%
summarize(the_mean = mean(percent_pos), na.rm = TRUE)
# plot bootstrapped CIs
pdf(file = "mansoni_data_median.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(bio01, med), sch_mansoni_temp_unq, col = 'red') +
labs(title = "S.mansoni",
x = 'Temperature (ºC)',
y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
# plot bootstrapped CIs
pdf(file = "mansoni_data_mean.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(bio01, the_mean), sch_mansoni_temp_unq_mean, col = 'red') +
labs(title = "S.mansoni",
x = 'Temperature (ºC)',
y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
bins_maker <- function(percentile, lenth_of_bin){
out_put <- matrix(0, nrow = 4, ncol = round(length(sch_mansoni_sort$bio01)/lenth_of_bin))
for (i in 1:round(length(sch_mansoni_sort$bio01)/lenth_of_bin)){
index_of_bin <- (1+(i-1)*lenth_of_bin):(i*lenth_of_bin)
out_put[1, i] <- sch_mansoni_sort$bio01[index_of_bin[lenth_of_bin/2]]
out_put[2, i] <- quantile(sch_mansoni_sort$percent_pos[index_of_bin], na.rm = TRUE, probs = percentile)
out_put[3, i] <- mean(sch_mansoni_sort$percent_pos[index_of_bin], na.rm = TRUE)
out_put[4, i] <- median(sch_mansoni_sort$percent_pos[index_of_bin], na.rm = TRUE)
}
return(out_put)
}
bins_data <-bins_maker(percentile = .98, lenth_of_bin = 400)
d <- data.frame(bins_data[1,], bins_data[2,])
colnames(d) <- c("temp", "prev")
# plot bootstrapped CIs
pdf(file = "mansoni_boost_r_not.pdf", width = 5, height = 5)
ggplot() +
geom_line(aes(temp, r_not_best), r_not_data, col = 'red', size = 1,) +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds, fill = 'red', alpha = 0.1) +
geom_point(aes(temp, prev*max(r_not_best)/max(prev)), d, size = 1, alpha = 0.5, colour = "red") +
labs(title = "S.mansoni", x = 'Temperature (ºC)',y = expression("R"[0]))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
d_mean <- data.frame(bins_data[1,], bins_data[3,])
colnames(d_mean) <- c("temp", "mean")
# plot bootstrapped CIs
pdf(file = "mansoni_data_mean_bin.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(temp, mean), d_mean, col = 'red') +
labs(title = "S.mansoni",
x = 'Temperature (ºC)',
y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
d_median <- data.frame(bins_data[1,], bins_data[4,])
colnames(d_median) <- c("temp", "median")
# plot bootstrapped CIs
pdf(file = "mansoni_data_median_bin.pdf", width = 5, height = 5)
ggplot() +
geom_point(aes(temp, median), d_median, col = 'red') +
labs(title = "S.mansoni",
x = 'Temperature (ºC)',
y = "Percent of positive case")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5))
dev.off()
############# Nguyen's result plot ######################
temp <- c(15.127, 15.763, 16.525, 16.949, 17.458, 17.881, 18.305, 18.814, 19.322, 19.831, 20.508, 21.186, 21.949, 22.797, 23.644, 24.153, 24.746,  25.085, 25.593,  26.102,  26.61,  27.119,  27.542,  28.136,  28.898, 29.576, 30.339,  31.441, 32.458, 33.814, 34.619)
rate <- c(0.11, 0.172, 0.282, 0.373, 0.467, 0.533, 0.621,  0.712, 0.806, 0.884, 0.953, 0.984, 0.994,  0.95, 0.84, 0.765, 0.665, 0.586,  0.502, 0.439, 0.376, 0.301, 0.254, 0.197, 0.144, 0.11, 0.072, 0.038, 0.025, 0.009, 0.009)
# keep just a single curve
.x <- data.frame(temp, rate)
nguyen <- nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
data = .x,
iter = c(4,4,4),
start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') - 10,
start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'gaussian_1987') + 10,
lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
supp_errors = 'Y')
fn_nguyen <- function(x) augment(nguyen, newdata = x)
df <- data.frame(x = r_not_data$temp, y2 = r_not_data$r_not_best, y1 = fn_nguyen(temperature)$.fitted)
# plot bootstrapped CIs
pdf(file = "mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
##################
pdf(file = "normalize_mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 0.5, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot_conf_preds_normalize, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
###############
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
##############################################################
pdf(file = "mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 1, alpha = 1, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
pdf(file = "mansoni_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(y2), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "red")) +
geom_point(aes(temp, prev/max(prev)), d, size = 2, alpha = 0.5, colour = "red") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'red', alpha = 0.1) +
labs(title = "S.mansoni", x = '',y = expression("R"[0]/max(("R"[0]))))+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
# Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "red", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "red", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "red", size = 1)
dev.off()
setwd("C:/Users/iaslan/OneDrive - Stanford/Desktop/GitHub/Thermal_sensitive_schistosomiasis_model/s.haematobium/r_not_mod_val_compare")
source("C:/Users/iaslan/OneDrive - Stanford/Desktop/GitHub/Thermal_sensitive_schistosomiasis_model/s.haematobium/r_not_mod_val_compare/haematobium_boot_r_not.R")
# plot bootstrapped CIs
pdf(file = "haematobium_compare_boost_r_not.pdf", width = 5, height = 5)
ggplot(data = df, aes(x = x)) +
geom_line(aes(y = y1/max(y1), colour = "Prev. Est."),size=1) +
geom_line(aes(y = y2/max(r_not_best), colour = "New Est."), size=1) +
scale_colour_manual("",
breaks = c("Prev. Est.", "New Est."),
values = c("grey", "blue")) +
geom_point(aes(temp, prev/max(prev)), d, size = 2, alpha = 0.5, colour = "blue") +
geom_ribbon(aes(temp, ymin = conf_lower/max(r_not_best), ymax = conf_upper/max(r_not_best)), boot_conf_preds, fill = 'blue', alpha = 0.1) +
labs(title = "S.haematobium", x = '',y = "")+
theme(legend.position="bottom", legend.key = element_rect(fill = "white"), panel.background = element_rect(fill = "white", colour = "black"), text = element_text(size = 17),
axis.text.x = element_text(color="black", size=17), axis.text.y = element_text(color="black", size=17),  panel.border = element_rect(colour = "black", fill=NA, size=1),
plot.title = element_text(size=14, face="bold.italic", hjust=0.5)) +
#Temperature (ºC)
# Add mark segment
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0, label = '^', colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y1)], y = 0.08,  label = round(df$x[which.max(df$y1)],1), colour = "grey", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0, label = '^', colour = "blue", size = 5) +
annotate("text", x = temperature$temp[which.max(df$y2)], y = 0.08, label = round(df$x[which.max(df$y2)],1), colour = "blue", size = 5) +
# Add horizontal line segment
geom_segment(aes(x = lower_bound, y = -0.02, xend = upper_bound, yend = -0.02), colour = "blue", size = 1)
dev.off()
#Calculate the mean sum square to compare the both ,model output quantitatively
new_temp_data_mss <- data.frame(temp = d$temp)
# combine two piece wise function of mu_i
preds_1 <- fn_mu_i_1(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp <= 37)]
preds_2 <- fn_mu_i_2(new_temp_data_mss)$.fitted[which(new_temp_data_mss$temp > 37)]
# This is mu_i function
preds_mu_i <- c(preds_1, preds_2)
r_not_best_mss <- (abs(lambda * fn_beta_s(new_temp_data_mss)$.fitted * h * fn_delta_e(new_temp_data_mss)$.fitted * nu_e
* fn_beta_h(new_temp_data_mss)$.fitted * fn_nu_c(new_temp_data_mss)$.fitted * fn_sigma_s(new_temp_data_mss)$.fitted/
(fn_mu_m(new_temp_data_mss)$.fitted * (mu_h + mu_p) * fn_mu_c(new_temp_data_mss)$.fitted * preds_mu_i *
(fn_sigma_s(new_temp_data_mss)$.fitted + preds_mu_i))))^(1/2)
nguyen_mss <- (fn_nguyen(new_temp_data_mss)$.fitted/max(fn_nguyen(new_temp_data_mss)$.fitted))*max(r_not_best_mss)
data_nss <- (d$prev/max(d$prev))*max(r_not_best_mss)
new_result <- sum((r_not_best_mss - data_nss)^2)/length(data_nss)
prev_result <- sum((nguyen_mss - data_nss)^2)/length(data_nss)
